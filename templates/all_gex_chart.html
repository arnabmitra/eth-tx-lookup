<div>
    {{ if .ChartData }}
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-semibold text-white mb-4">GEX Distribution for {{ .Symbol }} - All Expiries (Spot: ${{ printf "%.2f" .SpotPrice }})</h3>
        
        {{ if gt .GammaFlipLevel 0.0 }}
        <div class="bg-gray-700 rounded-lg p-4 mb-4 border-2 border-yellow-500">
            <div class="grid grid-cols-1 gap-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="text-lg font-semibold text-yellow-400">‚ö° Gamma Flip Level</h4>
                        <p class="text-2xl font-bold text-white mt-1">${{ printf "%.2f" .GammaFlipLevel }}</p>
                    </div>
                    <div class="border-l-2 border-gray-600 pl-6">
                        <p class="text-sm text-gray-300">Current Price</p>
                        <p class="text-2xl font-bold text-blue-400 mt-1">${{ printf "%.2f" .SpotPrice }}</p>
                    </div>
                </div>
                <div>
                    <p class="text-sm text-gray-300">Total GEX</p>
                    <p class="text-lg font-semibold {{ if gt .TotalGEX 0.0 }}text-green-400{{ else }}text-red-400{{ end }}">{{ .TotalGEXFormatted }}</p>
                </div>
            </div>
            <div class="mt-3 text-sm text-gray-300">
                {{ if gt .SpotPrice .GammaFlipLevel }}
                <p>‚úÖ <strong>Above flip:</strong> Market in <span class="text-green-400">positive GEX zone</span> - dealer hedging stabilizes price</p>
                {{ else }}
                <p>‚ö†Ô∏è <strong>Below flip:</strong> Market in <span class="text-red-400">negative GEX zone</span> - dealer hedging amplifies moves</p>
                {{ end }}
            </div>
        </div>
        {{ end }}
        
        <div id="d3-chart-partial" class="w-full"></div>
    </div>
    <script>
    (function() {
        // Wait for D3 to be available
        if (typeof d3 === 'undefined') {
            console.error('D3.js is not loaded');
            return;
        }
        // Chart data from Go
        const chartData = {{ .ChartData }};
        const spotPrice = {{ .SpotPrice }};
        const gammaFlipLevel = {{ .GammaFlipLevel }};
        
        // Clear any existing chart
        d3.select("#d3-chart-partial").selectAll("*").remove();
        
        // Set up dimensions - responsive
        const containerWidth = document.getElementById('d3-chart-partial').offsetWidth;
        const margin = {top: 40, right: 40, bottom: 100, left: 100};
        const width = containerWidth - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;

        // Create SVG
        const svg = d3.select("#d3-chart-partial")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .style("background", "#1f2937")
            .style("border-radius", "0.5rem")
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // X Scale (Strike Prices)
        const x = d3.scaleBand()
            .domain(chartData.map(d => d.strike))
            .range([0, width])
            .padding(0.4);

        // Y Scale (GEX Values)
        const yExtent = d3.extent(chartData, d => d.gex);
        const y = d3.scaleLinear()
            .domain([Math.min(yExtent[0], 0), Math.max(yExtent[1], 0)])
            .range([height, 0]);

        // Add X Axis
        svg.append("g")
            .attr("transform", `translate(0,${y(0)})`)
            .call(d3.axisBottom(x).tickValues(
                x.domain().filter((d, i) => i % Math.ceil(chartData.length / 20) === 0)
            ))
            .selectAll("text")
            .attr("transform", "rotate(-45)")
            .style("text-anchor", "end")
            .style("fill", "#f9fafb")
            .style("font-size", "13px")
            .style("font-weight", "500");

        // Add Y Axis
        svg.append("g")
            .call(d3.axisLeft(y).tickFormat(d => `$${d3.format(",.0f")(d)}`))
            .selectAll("text")
            .style("fill", "#f9fafb")
            .style("font-size", "13px")
            .style("font-weight", "500");

        // Style axis lines
        svg.selectAll(".domain, .tick line")
            .style("stroke", "#9ca3af");

        // Add X Axis Label
        svg.append("text")
            .attr("x", width / 2)
            .attr("y", height + margin.bottom - 15)
            .style("text-anchor", "middle")
            .style("fill", "#f3f4f6")
            .style("font-size", "16px")
            .style("font-weight", "600")
            .text("Strike Price");

        // Add Y Axis Label
        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("x", -height / 2)
            .attr("y", -margin.left + 15)
            .style("text-anchor", "middle")
            .style("fill", "#f3f4f6")
            .style("font-size", "16px")
            .style("font-weight", "600")
            .text("Gamma Exposure (GEX)");

        // Create tooltip
        const tooltip = d3.select("body")
            .append("div")
            .style("position", "absolute")
            .style("background", "#1f2937")
            .style("padding", "12px")
            .style("border", "2px solid #34d399")
            .style("border-radius", "8px")
            .style("pointer-events", "none")
            .style("opacity", 0)
            .style("color", "#f3f4f6")
            .style("font-size", "14px")
            .style("box-shadow", "0 4px 6px rgba(0, 0, 0, 0.3)")
            .style("z-index", "1000");

        // Add bars
        svg.selectAll(".bar")
            .data(chartData)
            .enter()
            .append("rect")
            .attr("class", "bar")
            .attr("x", d => x(d.strike))
            .attr("width", x.bandwidth())
            .attr("y", d => d.gex >= 0 ? y(d.gex) : y(0))
            .attr("height", d => Math.abs(y(d.gex) - y(0)))
            .attr("fill", d => d.gex >= 0 ? "#34d399" : "#ef4444")
            .style("cursor", "pointer")
            .style("transition", "opacity 0.2s")
            .on("mouseover", function(event, d) {
                d3.select(this)
                    .style("opacity", 0.7);
                
                tooltip
                    .style("opacity", 1)
                    .html(`
                        <div style="font-weight: 600; margin-bottom: 6px; color: ${d.gex >= 0 ? '#34d399' : '#ef4444'}">
                            ${d.gex >= 0 ? 'üü¢ Positive GEX' : 'üî¥ Negative GEX'}
                        </div>
                        <strong>Strike:</strong> $${d.strike.toFixed(2)}<br>
                        <strong>GEX:</strong> $${d3.format(",.2f")(d.gex)}<br>
                        <strong>Effect:</strong> ${d.gex >= 0 ? 'Stabilizer (Support/Resistance)' : 'Accelerator (Amplifies moves)'}
                    `)
                    .style("left", (event.pageX + 15) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mousemove", function(event) {
                tooltip
                    .style("left", (event.pageX + 15) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function() {
                d3.select(this)
                    .style("opacity", 1);
                
                tooltip.style("opacity", 0);
            });

        // Add zero line with label
        svg.append("line")
            .attr("x1", 0)
            .attr("x2", width)
            .attr("y1", y(0))
            .attr("y2", y(0))
            .style("stroke", "#9ca3af")
            .style("stroke-width", 2)
            .style("stroke-dasharray", "5,5");

        svg.append("text")
            .attr("x", width - 10)
            .attr("y", y(0) - 5)
            .style("text-anchor", "end")
            .style("fill", "#9ca3af")
            .style("font-size", "12px")
            .style("font-weight", "600")
            .text("Zero Gamma Level");

        // Add spot price line
        if (spotPrice > 0) {
            svg.append("line")
                .attr("x1", 0)
                .attr("x2", width)
                .attr("y1", height / 2)
                .attr("y2", height / 2)
                .style("stroke", "#60a5fa")
                .style("stroke-width", 2)
                .style("stroke-dasharray", "8,4");

            svg.append("text")
                .attr("x", width - 10)
                .attr("y", height / 2 - 5)
                .style("text-anchor", "end")
                .style("fill", "#60a5fa")
                .style("font-size", "12px")
                .style("font-weight", "700")
                .text(`Spot: $${spotPrice.toFixed(2)}`);
        }

        // Add gamma flip level line
        if (gammaFlipLevel > 0) {
            svg.append("line")
                .attr("x1", 0)
                .attr("x2", width)
                .attr("y1", height / 3)
                .attr("y2", height / 3)
                .style("stroke", "#fbbf24")
                .style("stroke-width", 3)
                .style("stroke-dasharray", "10,5");

            svg.append("text")
                .attr("x", 10)
                .attr("y", height / 3 - 8)
                .style("text-anchor", "start")
                .style("fill", "#fbbf24")
                .style("font-size", "14px")
                .style("font-weight", "700")
                .text(`‚ö° Gamma Flip: $${gammaFlipLevel.toFixed(2)}`);
        }
    })();
    </script>
    {{ end }}

    {{ if .GEXData }}
    <div class="mt-10">
        <h2 class="text-2xl font-semibold leading-6 text-white">Gamma Exposure (GEX) Across All Expiries:</h2>
        <br/> <br/>
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-800">
            <tr>
                <th scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                    Strike Price
                </th>
                <th scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                    GEX
                </th>
            </tr>
            </thead>
            <tbody class="bg-gray-700 divide-y divide-gray-600">
            {{ range .GEXData }}
            <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-300">{{ .Strike }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{{ .GEX }}</td>
            </tr>
            {{ end }}
            </tbody>
        </table>
    </div>
    {{ end }}
</div>